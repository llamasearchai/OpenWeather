<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - OpenWeather Platform</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <!-- Custom CSS -->
    <link href="/static/css/dashboard.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-cloud-sun"></i> OpenWeather Platform
            </a>
            
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/monitoring">Monitoring</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/weather">Weather</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics">Analytics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/drone">Drone Ops</a>
                    </li>
                </ul>
                
                <div class="navbar-text">
                    <small class="text-light">
                        <i class="fas fa-clock"></i> <span id="current-time">{{ timestamp }}</span>
                    </small>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Alert Banner -->
        <div id="alert-banner" class="alert alert-warning alert-dismissible fade show d-none" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="alert-message"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Status Overview Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-muted mb-0">System Health</h6>
                                <h3 class="mb-0" id="system-health-value">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </h3>
                            </div>
                            <div class="text-success">
                                <i class="fas fa-heartbeat fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-muted mb-0">Active Alerts</h6>
                                <h3 class="mb-0" id="active-alerts-value">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </h3>
                            </div>
                            <div class="text-warning">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-muted mb-0">Cache Hit Rate</h6>
                                <h3 class="mb-0" id="cache-hit-rate-value">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </h3>
                            </div>
                            <div class="text-info">
                                <i class="fas fa-database fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-muted mb-0">Total Requests</h6>
                                <h3 class="mb-0" id="total-requests-value">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </h3>
                            </div>
                            <div class="text-primary">
                                <i class="fas fa-chart-line fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- System Metrics Chart -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-server"></i> System Resources
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="system-metrics-chart" style="height: 400px;">
                            <div class="d-flex justify-content-center align-items-center h-100">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weather Chart -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cloud-sun"></i> Weather Forecast
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="weather-chart" style="height: 400px;">
                            <div class="d-flex justify-content-center align-items-center h-100">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Data Row -->
        <div class="row mb-4">
            <!-- Recent Weather Data -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-globe"></i> Global Weather Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="weather-table">
                                <thead>
                                    <tr>
                                        <th>Location</th>
                                        <th>Temperature</th>
                                        <th>Humidity</th>
                                        <th>Wind Speed</th>
                                        <th>Pressure</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            Loading weather data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cog"></i> System Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="mb-3">
                                    <div class="progress-circle" data-percentage="0" id="cpu-progress">
                                        <span class="progress-value">0%</span>
                                    </div>
                                    <small class="text-muted d-block mt-2">CPU</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="mb-3">
                                    <div class="progress-circle" data-percentage="0" id="memory-progress">
                                        <span class="progress-value">0%</span>
                                    </div>
                                    <small class="text-muted d-block mt-2">Memory</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="mb-3">
                                    <div class="progress-circle" data-percentage="0" id="disk-progress">
                                        <span class="progress-value">0%</span>
                                    </div>
                                    <small class="text-muted d-block mt-2">Disk</small>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div id="status-indicators">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>API Service</span>
                                <span class="badge bg-success" id="api-status">Online</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Weather Providers</span>
                                <span class="badge bg-success" id="weather-providers-status">Active</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Analytics Engine</span>
                                <span class="badge bg-success" id="analytics-status">Running</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Monitoring</span>
                                <span class="badge bg-success" id="monitoring-status">Active</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-muted py-3">
            <small>
                OpenWeather Platform - Enterprise Weather Analytics with AI &copy; 2024
                | Last updated: <span id="last-update">{{ timestamp }}</span>
            </small>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // WebSocket connection
        let ws = null;
        let reconnectInterval = null;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                clearInterval(reconnectInterval);
                hideAlert();
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateDashboard(data);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                showAlert('Connection lost. Attempting to reconnect...', 'warning');
                attemptReconnect();
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                showAlert('Connection error. Please check your network.', 'danger');
            };
        }

        function attemptReconnect() {
            reconnectInterval = setInterval(() => {
                console.log('Attempting to reconnect...');
                connectWebSocket();
            }, 5000);
        }

        function updateDashboard(data) {
            if (data.type === 'realtime_update' && data.data) {
                const summary = data.data;
                
                // Update status cards
                document.getElementById('system-health-value').innerHTML = 
                    `<span class="text-${getHealthColor(summary.system_health.overall_status)}">${summary.system_health.overall_status.toUpperCase()}</span>`;
                
                document.getElementById('active-alerts-value').textContent = summary.system_health.active_alerts;
                document.getElementById('cache-hit-rate-value').textContent = 
                    `${(summary.weather_service.cache_hit_rate * 100).toFixed(1)}%`;
                document.getElementById('total-requests-value').textContent = 
                    summary.performance.total_requests.toLocaleString();
                
                // Update progress circles
                updateProgressCircle('cpu-progress', summary.system_resources.cpu_usage);
                updateProgressCircle('memory-progress', summary.system_resources.memory_usage);
                updateProgressCircle('disk-progress', summary.system_resources.disk_usage);
                
                // Update timestamp
                document.getElementById('last-update').textContent = new Date(data.timestamp).toLocaleTimeString();
            }
        }

        function getHealthColor(status) {
            switch(status.toLowerCase()) {
                case 'healthy': return 'success';
                case 'degraded': return 'warning';
                case 'unhealthy': return 'danger';
                default: return 'secondary';
            }
        }

        function updateProgressCircle(elementId, percentage) {
            const element = document.getElementById(elementId);
            const value = Math.round(percentage);
            
            element.setAttribute('data-percentage', value);
            element.querySelector('.progress-value').textContent = `${value}%`;
            
            // Update color based on value
            const color = value > 80 ? 'danger' : value > 60 ? 'warning' : 'success';
            element.className = `progress-circle text-${color}`;
        }

        function showAlert(message, type = 'warning') {
            const alertBanner = document.getElementById('alert-banner');
            const alertMessage = document.getElementById('alert-message');
            
            alertBanner.className = `alert alert-${type} alert-dismissible fade show`;
            alertMessage.textContent = message;
        }

        function hideAlert() {
            const alertBanner = document.getElementById('alert-banner');
            alertBanner.classList.add('d-none');
        }

        // Load initial data
        async function loadInitialData() {
            try {
                // Load dashboard summary
                const summaryResponse = await fetch('/api/dashboard/summary');
                const summary = await summaryResponse.json();
                updateDashboard({ type: 'realtime_update', data: summary, timestamp: new Date().toISOString() });
                
                // Load system metrics chart
                const systemChartResponse = await fetch('/api/dashboard/chart/system');
                const systemChart = await systemChartResponse.json();
                if (systemChart.chart) {
                    Plotly.newPlot('system-metrics-chart', JSON.parse(systemChart.chart));
                }
                
                // Load weather chart
                const weatherChartResponse = await fetch('/api/dashboard/chart/weather');
                const weatherChart = await weatherChartResponse.json();
                if (weatherChart.chart) {
                    Plotly.newPlot('weather-chart', JSON.parse(weatherChart.chart));
                }
                
                // Load weather data
                const weatherResponse = await fetch('/api/dashboard/weather');
                const weatherData = await weatherResponse.json();
                updateWeatherTable(weatherData.locations || []);
                
            } catch (error) {
                console.error('Error loading initial data:', error);
                showAlert('Failed to load dashboard data. Please refresh the page.', 'danger');
            }
        }

        function updateWeatherTable(locations) {
            const tbody = document.querySelector('#weather-table tbody');
            
            if (locations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No weather data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = locations.map(location => `
                <tr>
                    <td>
                        <i class="fas fa-map-marker-alt text-muted"></i>
                        ${location.location}
                    </td>
                    <td>${location.temperature.toFixed(1)}°C</td>
                    <td>${location.humidity}%</td>
                    <td>${location.wind_speed.toFixed(1)} m/s</td>
                    <td>${location.pressure.toFixed(0)} hPa</td>
                    <td>
                        <span class="badge bg-success">
                            <i class="fas fa-check"></i> Active
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // Update current time
        function updateCurrentTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            connectWebSocket();
            
            // Update time every second
            setInterval(updateCurrentTime, 1000);
            updateCurrentTime();
        });
    </script>
</body>
</html> 